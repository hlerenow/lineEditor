lineEditor=function(e){var t=0,n=-1,i=function(n){if(!e)throw Error("该插件需要jquery支持");return this instanceof i?(this.editorContainer=e(n),this.id=t,t++,this.nowLine=0,void(this.domHtml=this.getDomTemplate())):new i(n)};return i.prototype={maxLine:555,getDomTemplate:function(){return'      <div id="lineNumberCon_'+this.id+'" class="lineNumberCon">        <div id="lineNumber_'+this.id+'" class="lineNumber">1</div>      </div>      <div id="contextEassy_'+this.id+'" class="contextEassy">            <p class="lineContext">请输入内容...</p>      </div>'},init:function(){if(!this.editorContainer)throw Error("编辑器容器不存。");e(this.editorContainer).addClass("easyCon"),this.editorContainer.html(this.domHtml),this.bodyEvent(),this.bodyEvent=function(){},this.windowResize(),this.windowResize=function(){},this.bindEvent(),e(this.editorContainer.find(".contextEassy")).attr("contenteditable","true")},bindEvent:function(){var t=this;this.activeEditor(),e(this.editorContainer).on("dragover",function(e){return e.preventDefault(),!1}),e(this.editorContainer).on("drop",function(e){return e.preventDefault(),!1}),e(this.editorContainer).on("paste",function(e){setTimeout(function(){t.wrapLine(n),t.alignLine(n),t.alignHeight(n)})}),e(this.editorContainer).keydown(function(i){if(n!==-1){if(46===i.keyCode)return i.preventDefault(),!1;var o=[33,34,35,36,37,38,39,40];o.indexOf(i.keyCode)===-1&&t.reDrawAll();var r=t.getNowLine();if(13==i.keyCode){var s=e("#contextEassy_"+n+" .lineContext"),a=e("#lineNumberCon_"+n+" .lineNumber");r++,setTimeout(function(){t.wrapLine(n,3)})}if(8==i.keyCode){var s=e("#contextEassy_"+n+" .lineContext"),a=e("#lineNumberCon_"+n+" .lineNumber"),l=s[r].textContent||s[r].innerText,d=window.getSelection().anchorOffset;if(0===r&&(0===d||1===d&&""==e.trim(l)))return i.preventDefault(),!1;if(0===d||1===d&&""==e.trim(l))return e(a[a.length-1]).remove(),void r--}}})},activeEditor:function(){var t=this;e(this.editorContainer).on("click",function(e){e.stopPropagation?e.stopPropagation():e.cancelBubble=!0,n=t.id})},closeEditor:function(){n=-1},bodyEvent:function(){e(document.body).on("click",function(e){n=-1})},getNowLine:function(){var t=window.getSelection().anchorNode,i=0,o=0;if(0==e("#contextEassy_"+n+" .lineContext").length)e("#contextEassy_"+n).append('<p class="lineContext"><br></p>');else try{for(;1!==t.nodeType||"p"!=t.nodeName.toLowerCase();)t=e(t).parent()[0];o=e("#contextEassy_"+n+" .lineContext").index(t)}catch(e){}return o>=0&&(i=o),i},getNowEditor:function(){var t=this.getNowLine(),i=e(e("#contextEassy_"+n+" .lineContext")[t]).parent()[0].id;n=parseInt(i.split("_")[1])},alignHeight:function(t,n){lines=e("#contextEassy_"+t+" .lineContext"),lineNumers=e("#lineNumberCon_"+t+" .lineNumber");var i=this.getNowLine(),o=lines.length;n&&(o=i+parseInt(n));for(var r=i;r<o;r++)e(lineNumers[r]).height()!=e(lines[r]).height()&&e(lineNumers[r]).css("height",e(lines[r]).height());for(var s=document.getElementById("contextEassy_"+t).childNodes,r=i;r<5;r++)s[r]&&3==s[r].nodeType&&""==e.trim(s[r].textContent)&&e(s[r]).remove()},alignLine:function(t,n){var i=e("#contextEassy_"+t+" .lineContext"),o=e("#lineNumberCon_"+t+" .lineNumber"),r=document.createDocumentFragment();if(i.length!=o.length){if(i.length>o.length){for(var s=o.length;s<i.length;s++){var a=document.createElement("div");a.className="lineNumber",a.textContent=s+1,r.appendChild(a)}return void e("#lineNumberCon_"+t).append(r)}if(i.length<o.length){for(var s=o.length;s>i.length;s--)e(o[s-1]).remove();return}}},getText:function(){for(var t=this.editorContainer.find(".lineContext"),n="",i=0;i<t.length;i++)n+=e(t[i]).text()+"\n";return n},getHtml:function(){return e(this.editorContainer.find(".contextEassy")[0]).html()},wrapLine:function(){for(var t=document.getElementById("contextEassy_"+n).childNodes,i=t.length,o=this.getNowLine(),r=o;r<i;r++)3===t[r].nodeType&&t[r].textContent&&e.trim(t[r].textContent)?e(t[r]).wrap('<p class="lineContext"/>'):3!==t[r].nodeType||""!=e.trim(t[r].textContent)?1!==t[r].nodeType||"p"==t[r].nodeName.toLowerCase()?1!==t[r].nodeType||"p"!=t[r].nodeName.toLowerCase()||e(t[r]).hasClass("lineContext")||e(t[r]).addClass("lineContext"):e(t[r]).replaceWith('<p class="lineContext">'+e(t[r]).text()+"</p>"):(e(t[r]).remove(),r--,i--)},windowResize:function(){var n=this;e(window).on("resize",function(){for(var e=0;e<t;e++)n.alignLine(e),n.alignHeight(e)})},reDrawAll:function(){var e=this;setTimeout(function(){e.alignLine(n),e.alignHeight(n),e.getNowEditor(n)})}},i}($);